---
layout: post
title: "Thinking about a random number generator"
date: 2024-01-01
categories: quint
---

**Foreword.** This is my first post about protocol specification since I have
left [Informal Systems][]. With a bit more free time on my hands, I want to
show everyone interested how to think about code and protocols with
specification languages such as [TLA+][] and [Quint][] as well as with tools
such as [Apalache][] and [TLC][]. Obviously, I am biased towards [Quint][] and
[Apalache][]. I believe both projects are great, but I am not going to sell
them to you :sunglasses:

## 1. The Story

In this blog post, I am going to tell you a short story about how I realized
that the [Quint][] simulator has a subtle bug in its pseudorandom number
generator (see [PRNG][] for context). If you have not heard about Quint yet,
check its [landing page](https://github.com/informalsystems/quint). In short,
Quint is a language and a set of tools for specifying and checking distributed
protocols, which is heavily inspired by the logic of [TLA+][]. Personally, I am
using Quint as replacement of pen and paper, whenever I have to think about
tricky code and protocols. Before Quint, I was using TLA+ for the same purpose.
The PRNG is an example of tricky code that did not fit into my brain.

Going back to the story, Quint has a randomized simulator. This simulator lets
you quickly try thousands of specification runs without thinking too much.  If
the simulator finds a bug, you know that the specification is broken. If it
does not find a bug, you may want to think about running more advanced tools
like a model checker. Many people I know stop after making the simulator happy,
introduce randomized tests in their Github actions and hope that the simulator
finds a bug in the CI one day, if there is a bug. If this sounds a lot like
[Property-based testing][] to you, you are completely right. Popularity of
tools like [Proptest][] among engineers led us to the idea of introducing the
randomized simulator in Quint. Moreover, [Vanlightly and Kuppe'22][] presented
the idea of randomized simulation at the TLA+ Conference 2022. (They did more
than that by evaluating statistical properties.)

Here is the [piece of my (buggy) code][] that extends a 32-bit PRNG into a PRNG
over big integers:

```typescript
    // 2^32 as bigint
    const U32: bigint = 0x100000000n
    // 2^64 as bigint
    const U64: bigint = 0x10000000000000000n
    /// ...
    next: (bound: bigint): bigint => {
      assert(bound > 0n)
      let input: bigint = bound
      let output: bigint = 0n
      let base: bigint = 1n
      while (input >= U32) {
        // produce pseudo-random least significant 32 bits,
        // while shifting the previous output to the left
        output = output * U32 + squares64(state)
        // advance the RNG state, while staying within 64 bits
        state = (state + 1n) % U64
        // forget the least significant 32 bits of the input
        input /= U32
        // shift the base by 32 bits to the left
        base *= U32
      }
      // Now we have to be careful to make `output` in the range [0, bound).
      // Produce 32 bits. Since we are using the modulo operator here,
      // the result is not exactly the uniform distribution.
      // It may be biased towards some values, especially for
      // the small values of `bound. If it becomes a problem in the future,
      // we should figure out, how to make the distribution uniform.
      output = (squares64(state) % input) * base + output
      // advance the RNG state, while staying within 64 bits
      state = (state + 1n) % U64
      return output
    },
```

[Informal Systems]: https://informal.systems
[TLA+]: https://lamport.azurewebsites.net/tla/tla.html
[Quint]: https://github.com/informalsystems/quint
[Apalache]: https://github.com/informalsystems/apalache
[TLC]: https://lamport.azurewebsites.net/tla/tools.html
[PRNG]: https://en.wikipedia.org/wiki/Pseudorandom_number_generator
[Property-based testing]: https://en.wikipedia.org/wiki/Software_testing#Property_testing
[Proptest]: https://crates.io/crates/proptest
[Vanlightly and Kuppe'22]: https://www.youtube.com/watch?v=cYenTPD7740
[piece of my (buggy) code]: https://github.com/informalsystems/quint/blob/8eca8a2db4f088130c8d485436c365384d3f4c6b/quint/src/rng.ts#L80-L108
